---
ms.openlocfilehash: eb227079656e2a57550511c3abfacb49935fe46a
ms.sourcegitcommit: 141fe5c30dea84029ef61cf82558c35f2a744b65
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/11/2020
ms.locfileid: "49655241"
---
<!-- markdownlint-disable MD002 MD041 -->

<span data-ttu-id="b0efb-101">この演習では、Azure Functions の実装を完了し、テスト アプリケーションを更新して、ユーザーの受信トレイの変更をサブスクライブおよびサブスクライブ解除 `SetSubscription` `Notify` します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-101">In this exercise you will finish implementing the Azure Functions `SetSubscription` and `Notify`, and update the test application to subscribe and unsubscribe to changes in a user's inbox.</span></span>

- <span data-ttu-id="b0efb-102">この関数は API として機能し、テスト アプリがユーザーの受信トレイの変更に対するサブスクリプションを作成 `SetSubscription` または削除できます。 [](https://docs.microsoft.com/graph/webhooks)</span><span class="sxs-lookup"><span data-stu-id="b0efb-102">The `SetSubscription` function will act as an API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.</span></span>
- <span data-ttu-id="b0efb-103">この `Notify` 関数は、サブスクリプションによって生成された変更通知を受信する Webhook として機能します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-103">The `Notify` function will act as the webhook that receives change notifications generated by the subscription.</span></span>

<span data-ttu-id="b0efb-104">どちらの関数も、クライアント資格情報 [の付与](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) フローを使用して、Microsoft Graph を呼び出すアプリ専用トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-104">Both functions will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph.</span></span> <span data-ttu-id="b0efb-105">管理者が必要なアクセス許可のスコープに管理者の同意を与えたため、トークンを取得するためにユーザーの操作は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="b0efb-105">Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.</span></span>

## <a name="add-client-credentials-authentication-to-the-azure-functions-project"></a><span data-ttu-id="b0efb-106">Azure Functions プロジェクトにクライアント資格情報認証を追加する</span><span class="sxs-lookup"><span data-stu-id="b0efb-106">Add client credentials authentication to the Azure Functions project</span></span>

<span data-ttu-id="b0efb-107">このセクションでは、Azure Functions プロジェクトにクライアント資格情報フローを実装して、Microsoft Graph と互換性のあるアクセス トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-107">In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.</span></span>

1. <span data-ttu-id="b0efb-108">**GraphTu clil.csproj** を含むディレクトリで CLI を開きます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-108">Open your CLI in the directory that contains **GraphTutorial.csproj**.</span></span>

1. <span data-ttu-id="b0efb-109">次のコマンドを使用して、Webhook アプリケーション ID とシークレットをシークレット ストアに追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-109">Add your webhook application ID and secret to the secret store using the following commands.</span></span> <span data-ttu-id="b0efb-110">`YOUR_WEBHOOK_APP_ID_HERE`Graph Azure 関数 Webhook のアプリケーション ID に **置き換える**。</span><span class="sxs-lookup"><span data-stu-id="b0efb-110">Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**.</span></span> <span data-ttu-id="b0efb-111">Graph Azure 関数 Webhook の Azure ポータルで作成したアプリケーション `YOUR_WEBHOOK_APP_SECRET_HERE` **シークレットに置き換える**。</span><span class="sxs-lookup"><span data-stu-id="b0efb-111">Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.</span></span>

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### <a name="create-a-client-credentials-authentication-provider"></a><span data-ttu-id="b0efb-112">クライアント資格情報認証プロバイダーを作成する</span><span class="sxs-lookup"><span data-stu-id="b0efb-112">Create a client credentials authentication provider</span></span>

1. <span data-ttu-id="b0efb-113">**./GraphTu ClientCredentialsAuthProvider.cs ディレクトリ** に新しいファイルを作成し **、次の** コードを追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-113">Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

<span data-ttu-id="b0efb-114">コードの動作を少し **ClientCredentialsAuthProvider.cs** してください。</span><span class="sxs-lookup"><span data-stu-id="b0efb-114">Take a moment to consider what the code in **ClientCredentialsAuthProvider.cs** does.</span></span>

- <span data-ttu-id="b0efb-115">コンストラクターでは、パッケージから **ConfidentialClientApplication** を初期化 `Microsoft.Identity.Client` します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-115">In the constructor, it initializes a **ConfidentialClientApplication** from the `Microsoft.Identity.Client` package.</span></span> <span data-ttu-id="b0efb-116">この関数を `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` 使用 `.WithTenantId(tenantId)` して、ログイン対象ユーザーを指定された Microsoft 365 組織にのみ制限します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-116">It uses the `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` and `.WithTenantId(tenantId)` functions to restrict the login audience to only the specified Microsoft 365 organization.</span></span>
- <span data-ttu-id="b0efb-117">関数では `GetAccessToken` 、アプリケーションの `AcquireTokenForClient` トークンを取得するために呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-117">In the `GetAccessToken` function, it calls `AcquireTokenForClient` to get a token for the application.</span></span> <span data-ttu-id="b0efb-118">クライアント資格情報トークン フローは常に非対話型です。</span><span class="sxs-lookup"><span data-stu-id="b0efb-118">The client credentials token flow is always non-interactive.</span></span>
- <span data-ttu-id="b0efb-119">インターフェイスを実装し、送信要求を認証するコンストラクターでこのクラス `Microsoft.Graph.IAuthenticationProvider` `GraphServiceClient` を渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-119">It implements the `Microsoft.Graph.IAuthenticationProvider` interface, allowing this class to be passed in the constructor of the `GraphServiceClient` to authenticate outgoing requests.</span></span>

## <a name="update-graphclientservice"></a><span data-ttu-id="b0efb-120">GraphClientService の更新</span><span class="sxs-lookup"><span data-stu-id="b0efb-120">Update GraphClientService</span></span>

1. <span data-ttu-id="b0efb-121">クラス **GraphClientService.cs** を開き、次のプロパティをクラスに追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-121">Open **GraphClientService.cs** and add the following property to the class.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

1. <span data-ttu-id="b0efb-122">既存の `GetAppGraphClient` 関数を、以下の関数で置き換えます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-122">Replace the existing `GetAppGraphClient` function with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientFunctions":::

## <a name="implement-notify-function"></a><span data-ttu-id="b0efb-123">Notify 関数を実装する</span><span class="sxs-lookup"><span data-stu-id="b0efb-123">Implement Notify function</span></span>

<span data-ttu-id="b0efb-124">このセクションでは、変更通知の通知 URL として使用される関数 `Notify` を実装します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-124">In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.</span></span>

1. <span data-ttu-id="b0efb-125">Models という名前の **GraphTu graphls** ディレクトリに新しいディレクトリを **作成します**。</span><span class="sxs-lookup"><span data-stu-id="b0efb-125">Create a new directory in the **GraphTutorials** directory named **Models**.</span></span>

1. <span data-ttu-id="b0efb-126">Models ディレクトリに新しいファイルを作成 **し、ResourceData.cs\*\*\*\*コードを** 追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-126">Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. <span data-ttu-id="b0efb-127">Models ディレクトリに新しいファイルを作成 **し、ChangeNotification.cs\*\*\*\*コードを** 追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-127">Create a new file in the **Models** directory named **ChangeNotification.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotification.cs" id="ChangeNotificationSnippet":::

1. <span data-ttu-id="b0efb-128">Models ディレクトリに新しいファイルを作成 **し、NotificationList.cs\*\*\*\*コードを** 追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-128">Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. <span data-ttu-id="b0efb-129">**./GraphTu graphl/Notify.cs** を開き、その内容全体を次の内容に置き換えてください。</span><span class="sxs-lookup"><span data-stu-id="b0efb-129">Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

<span data-ttu-id="b0efb-130">コードの動作を少し **Notify.cs** してください。</span><span class="sxs-lookup"><span data-stu-id="b0efb-130">Take a moment to consider what the code in **Notify.cs** does.</span></span>

- <span data-ttu-id="b0efb-131">この `Run` 関数は、クエリ パラメーターの有無を `validationToken` 確認します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-131">The `Run` function checks for the presence of a `validationToken` query parameter.</span></span> <span data-ttu-id="b0efb-132">このパラメーターが指定されている場合は、要求を検証要求として処理 [し、それに](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation)応じて応答します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-132">If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.</span></span>
- <span data-ttu-id="b0efb-133">要求が検証要求ではない場合、JSON ペイロードは逆シリアル化され、 `NotificationList` .</span><span class="sxs-lookup"><span data-stu-id="b0efb-133">If the request is not a validation request, the JSON payload is deserialized into a `NotificationList`.</span></span>
- <span data-ttu-id="b0efb-134">一覧内の各通知で、予期されるクライアント状態の値がチェックされ、処理されます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-134">Each notification in the list is checked for the expected client state value, and is processed.</span></span>
- <span data-ttu-id="b0efb-135">通知をトリガーしたメッセージは、Microsoft Graph で取得されます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-135">The message that triggered the notification is retrieved with Microsoft Graph.</span></span>

## <a name="implement-setsubscription-function"></a><span data-ttu-id="b0efb-136">SetSubscription 関数を実装する</span><span class="sxs-lookup"><span data-stu-id="b0efb-136">Implement SetSubscription function</span></span>

<span data-ttu-id="b0efb-137">このセクションでは、SetSubscription 関数を実装します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-137">In this section, you'll implement the SetSubscription function.</span></span> <span data-ttu-id="b0efb-138">この関数は、ユーザーの受信トレイでサブスクリプションを作成または削除するためにテスト アプリケーションによって呼び出される API として機能します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-138">This function will act as an API that is called by the test application to create or delete a subscription on a user's inbox.</span></span>

1. <span data-ttu-id="b0efb-139">Models ディレクトリに新しいファイルを作成 **し、SetSubscriptionPayload.cs\*\*\*\*コードを** 追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-139">Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. <span data-ttu-id="b0efb-140">**./GraphTu graphl/SetSubscription.cs** を開き、そのコンテンツ全体を次の内容に置き換えてください。</span><span class="sxs-lookup"><span data-stu-id="b0efb-140">Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

<span data-ttu-id="b0efb-141">コードの動作を少し **SetSubscription.cs** してください。</span><span class="sxs-lookup"><span data-stu-id="b0efb-141">Take a moment to consider what the code in **SetSubscription.cs** does.</span></span>

- <span data-ttu-id="b0efb-142">この関数は、POST 要求で送信された JSON ペイロードを読み取り、要求の種類 (サブスクライブまたはサブスクライブ解除)、サブスクライブするユーザー ID、登録を解除するサブスクリプション ID を `Run` 決定します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-142">The `Run` function reads the JSON payload sent in the POST request to determine the request type (subscribe or unsubscribe), the user ID to subscribe for, and the subscription ID to unsubscribe.</span></span>
- <span data-ttu-id="b0efb-143">要求がサブスクライブ要求の場合は、Microsoft Graph SDK を使用して、指定したユーザーの受信トレイに新しいサブスクリプションを作成します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-143">If the request is a subscribe request, it uses the Microsoft Graph SDK to create a new subscription in the specified user's inbox.</span></span> <span data-ttu-id="b0efb-144">サブスクリプションは、メッセージが作成または更新された場合に通知します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-144">The subscription will notify when messages are created or updated.</span></span> <span data-ttu-id="b0efb-145">新しいサブスクリプションは、応答の JSON ペイロードで返されます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-145">The new subscription is returned in the JSON payload of the response.</span></span>
- <span data-ttu-id="b0efb-146">要求が登録解除要求の場合は、Microsoft Graph SDK を使用して指定されたサブスクリプションを削除します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-146">If the request is an unsubscribe request, it uses the Microsoft Graph SDK to delete the specified subscription.</span></span>

## <a name="call-setsubscription-from-the-test-app"></a><span data-ttu-id="b0efb-147">テスト アプリから SetSubscription を呼び出す</span><span class="sxs-lookup"><span data-stu-id="b0efb-147">Call SetSubscription from the test app</span></span>

<span data-ttu-id="b0efb-148">このセクションでは、テスト アプリでサブスクリプションを作成および削除する関数を実装します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-148">In this section, you'll implement functions to create and delete subscriptions in the test app.</span></span>

1. <span data-ttu-id="b0efb-149">**./TestClient/azurefunctions.js** 開き、次の関数を追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-149">Open **./TestClient/azurefunctions.js** and add the following function.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="createSubscriptionSnippet":::

    <span data-ttu-id="b0efb-150">このコードは、Azure 関数を呼び出してサブスクライブし、セッション内のサブスクリプションの配列に新しい `SetSubscription` サブスクリプションを追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-150">This code calls the `SetSubscription` Azure Function to subscribe and adds the new subscription to the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="b0efb-151">次の関数を追加 **して** azurefunctions.js。</span><span class="sxs-lookup"><span data-stu-id="b0efb-151">Add the following function to **azurefunctions.js**.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="deleteSubscriptionSnippet":::

    <span data-ttu-id="b0efb-152">このコードは、Azure 関数を呼び出して、セッション内のサブスクリプションの配列からサブスクリプションを解除 `SetSubscription` し、削除します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-152">This code calls the `SetSubscription` Azure Function to un and removes the subscription from the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="b0efb-153">ngrok が実行されていない場合は、ngrok ( ) を実行し、HTTPS 転送 `ngrok http 7071` URL をコピーします。</span><span class="sxs-lookup"><span data-stu-id="b0efb-153">If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.</span></span>

1. <span data-ttu-id="b0efb-154">次のコマンドを実行して、ngrok URL をユーザー シークレット ストアに追加します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-154">Add the ngrok URL to the user secrets store by running the following command.</span></span>

    ```Shell
    dotnet user-secrets set ngrokUrl "YOUR_NGROK_URL_HERE"
    ```

    > [!IMPORTANT]
    > <span data-ttu-id="b0efb-155">ngrok を再起動する場合は、このコマンドを繰り返して ngrok URL を更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b0efb-155">If you restart ngrok, you will need to repeat this command to update your ngrok URL.</span></span>

1. <span data-ttu-id="b0efb-156">CLI の現在のディレクトリを **./GraphTu clil** ディレクトリに変更し、次のコマンドを実行して Azure 関数をローカルで開始します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-156">Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.</span></span>

    ```Shell
    func start
    ```

1. <span data-ttu-id="b0efb-157">SPA を更新し、[サブスクリプション] ナビゲーション **項目を** 選択します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-157">Refresh the SPA and select the **Subscriptions** nav item.</span></span> <span data-ttu-id="b0efb-158">Exchange Online メールボックスを持つ Microsoft 365 組織のユーザーのユーザー ID を入力します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-158">Enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox.</span></span> <span data-ttu-id="b0efb-159">これは、ユーザー (Microsoft Graph から) またはユーザーのいずれか `id` です `userPrincipalName` 。</span><span class="sxs-lookup"><span data-stu-id="b0efb-159">This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`.</span></span> <span data-ttu-id="b0efb-160">[サブスクライブ **] をクリックします**。</span><span class="sxs-lookup"><span data-stu-id="b0efb-160">Click **Subscribe**.</span></span>

1. <span data-ttu-id="b0efb-161">ページが更新され、表に新しいサブスクリプションが表示されます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-161">The page refreshes showing the new subscription in the table.</span></span>

1. <span data-ttu-id="b0efb-162">ユーザーにメールを送信します。</span><span class="sxs-lookup"><span data-stu-id="b0efb-162">Send an email to the user.</span></span> <span data-ttu-id="b0efb-163">しばらくすると、関数 `Notify` が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-163">After a brief time, the `Notify` function should be called.</span></span> <span data-ttu-id="b0efb-164">これは、ngrok Web インターフェイス ( ) または Azure Function プロジェクトの `http://localhost:4040` デバッグ出力で確認できます。</span><span class="sxs-lookup"><span data-stu-id="b0efb-164">You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.</span></span>

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. <span data-ttu-id="b0efb-165">テスト アプリで、サブスクリプション **の表の** 行で [削除] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="b0efb-165">In the test app, click **Delete** in the table row for the subscription.</span></span> <span data-ttu-id="b0efb-166">ページが更新され、サブスクリプションがテーブルに表示されなくなりました。</span><span class="sxs-lookup"><span data-stu-id="b0efb-166">The page refreshes and the subscription is no longer in the table.</span></span>
